

/* web/extensions/colormap/colormap.min.js */
var cmap={ext_name:"colormap",first_time:!0,which:0,R:0,G:1,B:2,color:["red","green","blue"],colors:["#ff0000","#00ff00","#2196F3"],rgb:0,draw_r:0,draw_g:0,draw_b:0,draw:0,draw_s:["points","lines"],draw_e:{points:0,lines:1},drawing:0,last_x:0,mousedown:0,w:384,h:128,h_ramp:32,button:0,gain_red:0,gain_green:0,gain_blue:0,n_custom:4,save:{},aper_algo:3,aper_algo_s:["IIR","MMA","EMA","off"],aper_algo_e:{IIR:0,MMA:1,EMA:2,OFF:3},aper_param:0,aper_param_s:["gain","averages","averages",""],aper_params:{IIR_min:0,IIR_max:2,IIR_step:.1,IIR_def:.8,IIR_val:void 0,MMA_min:1,MMA_max:16,MMA_step:1,MMA_def:2,MMA_val:void 0,EMA_min:1,EMA_max:16,EMA_step:1,EMA_def:2,EMA_val:void 0},ef:0};function colormap_main(){ext_switch_to_client(cmap.ext_name,cmap.first_time,colormap_recv),cmap.first_time||colormap_controls_setup(),cmap.first_time=!1}function colormap_recv(a){if("DAT"!=arrayBufferToStringLen(a,3))for(var r=arrayBufferToString(a).substring(4).split(" "),c=0;c<r.length;c++){var e=r[c].split("=");switch(e[0]){case"ready":colormap_controls_setup();break;default:console.log("colormap_recv: UNKNOWN CMD "+e[0])}}else{var p=new Uint8Array(a,4),o=p[0],m=p.length-1;console.log("colormap_recv: DATA UNKNOWN cmd="+o+" len="+m)}}function colormap_plot(){}function colormap_controls_setup(){var a=w3_div("id-colormap-controls w3-text-white",w3_divs("",w3_div("w3-medium w3-text-aqua w3-margin-B-16","<b>Colormap control</b>"),w3_col_percent("w3-valign w3-margin-T-8/",w3_div("w3-text-css-orange","<b>Aperture<br>auto<br>mode</b>"),17,w3_select("id-cmap-aper-algo|color:red","Averaging","","cmap.aper_algo",cmap.aper_algo,cmap.aper_algo_s,"colormap_aper_algo_cb"),20,w3_div("id-cmap-aper-param",w3_slider("id-cmap-aper-param-slider","Parameter","cmap.aper_param",cmap.aper_param,0,10,1,"colormap_aper_param_cb")),40,"&nbsp;",3,w3_div("id-cmap-aper-param-field")),w3_inline("id-cmap-maxmin w3-margin-T-8 w3-hide w3-text-white w3-small/","Min/max:&nbsp;",w3_div("id-cmap-min"),"/",w3_div("id-cmap-max"),"&nbsp;=&nbsp;",w3_div("id-cmap-min-comp"),"/",w3_div("id-cmap-max-comp"),"&nbsp;(computed) +&nbsp;",w3_div("id-cmap-min-floor"),"/",w3_div("id-cmap-max-ceil"),"&nbsp;(floor/ceil)"),w3_div("id-cmap-maxmin-empty w3-margin-T-8 w3-small","&nbsp;"),w3_col_percent("w3-margin-T-32 w3-margin-B-16 w3-valign/",w3_div("w3-text-css-orange","<b>Colormap<br>designer</b>"),20,w3_select("|color:red","","colormap","wf.cmap",wf.cmap,kiwi.cmap_s,"wf_cmap_cb"),27,w3_div("w3-text-white","select custom colormap<br>then draw in box below"),40,w3_button("w3-btn w3-round-xlarge w3-padding-small w3-aqua","clear","colormap_clear_button_cb")),w3_divs("",w3_col_percent("w3-valign/",w3_radio_button("id-cmap-btn-red w3-btn w3-round-xlarge w3-padding-small","red",cmap.button,w3_SELECTED,"colormap_color_button_cb",0),17,w3_select("|color:red","","draw","cmap.draw_r",cmap.draw_r,cmap.draw_s,"colormap_draw_mode_cb",0),20,w3_slider("id-cmap-gain-red-slider","","cmap.gain_red",cmap.gain_red,-1.04,1.04,.01,"colormap_color_gain_cb",0),40,"&nbsp;",3,w3_div("id-cmap-gain-red-field")),w3_col_percent("w3-valign w3-margin-T-8/",w3_radio_button("id-cmap-btn-green w3-btn w3-round-xlarge w3-padding-small","green",cmap.button,w3_NOT_SELECTED,"colormap_color_button_cb",1),17,w3_select("|color:red","","draw","cmap.draw_g",cmap.draw_g,cmap.draw_s,"colormap_draw_mode_cb",1),20,w3_slider("id-cmap-gain-red-slider","","cmap.gain_green",cmap.gain_green,-1.04,1.04,.01,"colormap_color_gain_cb",1),40,"&nbsp;",3,w3_div("id-cmap-gain-green-field")),w3_col_percent("w3-valign w3-margin-T-8 w3-margin-B-16/",w3_radio_button("id-cmap-btn-blue w3-btn w3-round-xlarge w3-padding-small","blue",cmap.button,w3_NOT_SELECTED,"colormap_color_button_cb",2),17,w3_select("|color:red","","draw","cmap.draw_b",cmap.draw_b,cmap.draw_s,"colormap_draw_mode_cb",2),20,w3_slider("id-cmap-gain-red-slider","","cmap.gain_blue",cmap.gain_blue,-1.04,1.04,.01,"colormap_color_gain_cb",2),40,"&nbsp;",3,w3_div("id-cmap-gain-blue-field")),w3_div("|border: 16px solid rgba(255,255,255,0.2); border-radius: 10px; width: 416px",w3_div("|left:0px; width:"+px(cmap.w)+"; height:"+px(cmap.h)+"; overflow:hidden; position:relative;",'<canvas id="id-cmap-transfer-canvas" width="'+cmap.w+'" height="'+cmap.h+'" style="position:absolute"></canvas>','<canvas id="id-cmap-overlay-canvas" width="'+cmap.w+'" height="'+cmap.h+'" style="position:absolute"></canvas>')),w3_div("w3-margin-L-16 w3-margin-T-16|left:0px; width:"+px(cmap.w)+"; height:"+px(cmap.h_ramp)+"; background-color:black; overflow:hidden; position:relative;",'<canvas id="id-cmap-ramp-canvas" width="'+cmap.w+'" height="'+cmap.h_ramp+'" style="position:absolute"></canvas>'))));for(ext_panel_show(a,null),ext_set_controls_width_height(440,530),wf.aper==kiwi.aper_e.auto&&(w3_show_inline("id-cmap-maxmin"),colormap_maxmin_cb(),w3_hide("id-cmap-maxmin-empty")),w3_set_highlight_color("id-cmap-btn-red","w3-red"),w3_set_highlight_color("id-cmap-btn-green","w3-green"),w3_set_highlight_color("id-cmap-btn-blue","w3-blue"),cmap.transfer_canvas=w3_el("id-cmap-transfer-canvas"),cmap.transfer_canvas.ctx=cmap.transfer_canvas.getContext("2d"),cmap.overlay_canvas=w3_el("id-cmap-overlay-canvas"),cmap.overlay_canvas.ctx=cmap.overlay_canvas.getContext("2d"),m=0;m<cmap.n_custom;m++)for(var r=cmap.save["cm"+m]={},c=0;c<3;c++){var e=r["rgb"[c]]={};e.gain_slider=0,e.gain=1,e.y=[];for(var p=0;p<cmap.w;p++)e.y[p]=0}var o=w3_el("id-colormap-controls");o.addEventListener("mousedown",colormap_transfer_mousedown_cb,!1),o.addEventListener("mousemove",colormap_transfer_mousemove_cb,!1),o.addEventListener("mouseup",colormap_transfer_mouseup_cb,!1),cmap.ramp_canvas=w3_el("id-cmap-ramp-canvas"),cmap.ramp_canvas.ctx=cmap.ramp_canvas.getContext("2d"),colormap_select()}function colormap_init(){var a=+ext_get_cfg_param("init.colormap",-1,EXT_NO_SAVE),r=readCookie("last_cmap",-1==a?0:a);-1!=wf.cmap_override&&(r=wf.cmap_override),wf_cmap_cb("wf.cmap",r,!1);var c=+ext_get_cfg_param("init.aperture",-1,EXT_NO_SAVE),e=readCookie("last_aper",-1==c?0:c);wf_aper_cb("wf.aper",e,!1),w3_show("id-aper-data"),wf.aper_w=parseFloat(w3_el("id-control").style.width),wf.aper_h=16,w3_el("id-aper-data").style.width=px(wf.aper_w);var p=w3_el("id-aper-canvas");p.width=wf.aper_w,wf.aper_ctx=p.getContext("2d"),wf.aper==kiwi.aper_e.man&&colormap_aper()}function colormap_select(){var a=cmap.which=wf.cmap>=kiwi.cmap_e.custom_1?wf.cmap-kiwi.cmap_e.custom_1:-1,r=localStorage.getItem("colormap");if(cmap.transfer_canvas&&-1==a){var c=cmap.transfer_canvas.ctx;c.fillStyle="black",c.fillRect(0,0,cmap.w,cmap.h),c.strokeStyle="white",c.beginPath(),c.moveTo(0,0),c.lineTo(cmap.w,cmap.h),c.stroke(),c.beginPath(),c.moveTo(cmap.w,0),c.lineTo(0,cmap.h),c.stroke(),(c=cmap.ramp_canvas.ctx).fillStyle="black",c.fillRect(0,0,cmap.w,cmap.h_ramp)}if(-1!=a&&null!=r){var e=kiwi_JSON_parse("colormap_select",r);if(e)if(cmap.save=e,cmap.transfer_canvas){var p=cmap.save["cm"+a];colormap_color_gain_cb("cmap.gain_red",p.r.gain_slider,1,!1,0),colormap_color_gain_cb("cmap.gain_green",p.g.gain_slider,1,!1,1),colormap_color_gain_cb("cmap.gain_blue",p.b.gain_slider,1,!1,2)}else colormap_update_wf_colormap()}}function colormap_aper(){if(wf.aper_ctx)for(var a=-140,r=0;r<wf.aper_w;r++){var c=r/wf.aper_w*120-140,e=color_index_max_min(c,maxdb,mindb),p=color_map[e];(mindb>=a&&mindb<=c||maxdb>=a&&maxdb<=c)&&(p^=4294967295);var o="#"+(p>>>8).toString(16).leadingZeros(6);wf.aper_ctx.fillStyle=o,wf.aper_ctx.fillRect(r,0,1,wf.aper_h),(c>=mindb-3&&c<=mindb||c>=maxdb&&c<=maxdb+3)&&(o="#"+((p=4294967295^color_map[e])>>>8).toString(16).leadingZeros(6),wf.aper_ctx.fillStyle=o,wf.aper_ctx.fillRect(r,wf.aper_h/2,1,1)),a=c}}function colormap_aper_algo_cb(a,r,c){if(c?(r=+readCookie("last_aper_algo",cmap.aper_algo_e.OFF),w3_set_value(a,r)):r=+r,wf.aper_algo=cmap.aper_algo=+r,cmap.aper_algo==cmap.aper_algo_e.OFF)w3_hide(w3_el("id-cmap-aper-param").parentElement),w3_innerHTML("id-cmap-aper-param-field","aperture auto-scale on <br> waterfall pan/zoom only"),colormap_update();else{var e=cmap.aper_algo,p=cmap.aper_algo_s[e],o=cmap.aper_params[p+"_val"];w3_show(w3_el("id-cmap-aper-param").parentElement),colormap_aper_param_cb("id-cmap-aper-param-slider",o,!0,!1)}writeCookie("last_aper_algo",cmap.aper_algo.toString()),freqset_select()}function colormap_aper_param_cb(a,r,c,e){if(!e){r=+r;var p=cmap.aper_algo,o=cmap.aper_algo_s[p],m=cmap.aper_params;if(isUndefined(r)||isNaN(r)){r=m[o+"_def"];var _=parseFloat(readCookie("last_aper_algo")),i=parseFloat(readCookie("last_aper_param"));_!=p||isNaN(i)||(r=i)}wf.aper_param=cmap.aper_param=m[o+"_val"]=r,w3_slider_setup("id-cmap-aper-param-slider",m[o+"_min"],m[o+"_max"],m[o+"_step"],r),w3_innerHTML("id-cmap-aper-param-field",p==cmap.aper_algo_e.OFF?"":r+" "+cmap.aper_param_s[p]),c&&(writeCookie("last_aper_param",r.toFixed(2)),colormap_update(),freqset_select())}}function colormap_maxmin_cb(){w3_innerHTML("id-cmap-max",maxdb.toString().positiveWithSign()),w3_innerHTML("id-cmap-max-comp",wf.auto_maxdb.toString().positiveWithSign()),w3_innerHTML("id-cmap-max-ceil",wf.auto_ceil.val.toString().positiveWithSign()),w3_innerHTML("id-cmap-min",mindb.toString().positiveWithSign()),w3_innerHTML("id-cmap-min-comp",wf.auto_mindb.toString().positiveWithSign()),w3_innerHTML("id-cmap-min-floor",wf.auto_floor.val.toString().positiveWithSign())}function colormap_color_button_cb(a,r,c,e){cmap.rgb=+e,cmap.draw=cmap["draw_"+"rgb"[cmap.rgb]]}function colormap_draw_mode_cb(a,r,c,e){r=+r,e=+e,cmap.rgb==e&&(cmap.draw=r),w3_num_cb(a,r)}function colormap_clear_button_cb(a,r){colormap_color_gain_cb("",0,!0,!1,cmap.R,0),colormap_color_gain_cb("",0,!0,!1,cmap.G,0),colormap_color_gain_cb("",0,!0,!1,cmap.B,0),localStorage.setItem("colormap",JSON.stringify(cmap.save))}function colormap_color_gain_cb(a,r,c,e,p,o){if(!e){var m=+p,_=r=+r;r>0&&r<.05?_=r=0:r>=.05&&(r-=.04),r<0&&r>-.05?_=r=0:r<=-.05&&(r+=.04);var i=r<0?1+r:1+2*r,l=cmap.color[m];if(w3_innerHTML("id-cmap-gain-"+l+"-field","gain "+i.toFixed(2)),-1!=cmap.which){var n=cmap.save["cm"+cmap.which]["rgb"[m]];n.gain_slider=r,n.gain=i,w3_set_value(a,_),w3_color(a,null,_<0?"rgba(255,0,0,0.3)":_?"rgba(0,255,0,0.2)":""),colormap_draw_transfer(m,0,cmap.w-1,1,o)}}}function colormap_draw_transfer(a,r,c,e,p){var o=cmap.which;if(-1!=o){var m,_,i=cmap.transfer_canvas.ctx,l=cmap.save["cm"+o];++a>=3&&(a=0);var n=(m=l["rgb"[a]]).gain,t=m.y,w=cmap.colors[a];++a>=3&&(a=0);var d=(m=l["rgb"[a]]).gain,s=m.y,g=cmap.colors[a];++a>=3&&(a=0);for(var f=(m=l["rgb"[a]]).gain,v=m.y,b=cmap.colors[a],u=r;e>0&&u<=c||e<0&&u>=c;u+=e)i.fillStyle="black",i.fillRect(u,0,1,cmap.h),_=t[u]*n,_=w3_clamp(Math.round(_),0,cmap.h-1),i.fillStyle=w,i.fillRect(u,_,2,2),_=s[u]*d,_=w3_clamp(Math.round(_),0,cmap.h-1),i.fillStyle=g,i.fillRect(u,_,2,2),_=isArg(p)?v[u]=p:v[u],_*=f,_=w3_clamp(Math.round(_),0,cmap.h-1),i.fillStyle=b,i.fillRect(u,_,2,2);var h=l.r.gain,x=l.g.gain,y=l.b.gain,M=l.r.y,S=l.g.y,T=l.b.y,k=(i=cmap.ramp_canvas.ctx,cmap.h-1);for(u=0;u<cmap.w;u++){var E=w3_clamp(M[u]*h,0,k);E=E/k*255;var A=w3_clamp(S[u]*x,0,k);A=A/k*255;var R=w3_clamp(T[u]*y,0,k);R=R/k*255,i.fillStyle=kiwi_rgb(E,A,R),i.fillRect(u,0,1,cmap.h_ramp)}colormap_update_wf_colormap()}}function colormap_update_wf_colormap(){var a=cmap.which;if(-1!=a){var r=wf.custom_colormaps[a],c=cmap.h-1,e=cmap.save["cm"+a],p=e.r.gain,o=e.g.gain,m=e.b.gain,_=e.r.y,i=e.g.y,l=e.b.y;for(x=0;x<256;x++){var n=Math.round(x/255*(cmap.w-1)),t=w3_clamp(_[n]*p,0,c);t=t/c*255;var w=w3_clamp(i[n]*o,0,c);w=w/c*255;var d=w3_clamp(l[n]*m,0,c);d=d/c*255,r[3*x+0]=w3_clamp(Math.round(t),0,255),r[3*x+1]=w3_clamp(Math.round(w),0,255),r[3*x+2]=w3_clamp(Math.round(d),0,255)}mkcolormap(),spectrum_dB_bands(),colormap_aper()}}function colormap_mouseXY(a,r){var c=w3_el(a).getBoundingClientRect();return{x:Math.round(r.clientX-c.left),y:Math.round(r.clientY-c.top)}}function colormap_transfer_mousedown_cb(a){switch(cmap.draw){case cmap.draw_e.points:cmap.mousedown=1;break;case cmap.draw_e.lines:if(!cmap.drawing){var r=colormap_mouseXY("id-cmap-overlay-canvas",a);if(r.y<-16||r.y>cmap.h+16||r.x<-16||r.x>cmap.w+16)return;cmap.xy0=r,cmap.xy1=null,cmap.drawing=1}}}function colormap_transfer_mousemove_cb(a){if(-1!=cmap.which)switch(cmap.draw){case cmap.draw_e.points:var r=colormap_mouseXY("id-cmap-transfer-canvas",a);if(!a.buttons||r.y<-16||r.y>cmap.h+16)return;var c=w3_clamp(r.y,0,cmap.h-1),e=w3_clamp(r.x,0,cmap.w-1);cmap.mousedown&&(cmap.last_x=e,cmap.mousedown=0);var p=e>=cmap.last_x?1:-1;colormap_draw_transfer(cmap.rgb,cmap.last_x,e,p,c),cmap.last_x=e;break;case cmap.draw_e.lines:if(!cmap.drawing)return;var o=cmap.overlay_canvas.ctx;cmap.xy1&&o.clearRect(0,0,cmap.w,cmap.h);r=colormap_mouseXY("id-cmap-overlay-canvas",a);return o.strokeStyle="white",o.beginPath(),o.moveTo(cmap.xy0.x,cmap.xy0.y),o.lineTo(r.x,r.y),o.stroke(),void(cmap.xy1=r);default:return}}function colormap_transfer_mouseup_cb(a,r){switch(cmap.draw){case cmap.draw_e.lines:if(!cmap.drawing)return;if(!cmap.xy1)return void(r&&(cmap.drawing=0));if(cmap.overlay_canvas.ctx.clearRect(0,0,cmap.w,cmap.h),r)cmap.drawing=0;else{colormap_bresenham(cmap.xy0,cmap.xy1,function(a,r){colormap_draw_transfer(cmap.rgb,a,a,1,r)});var c=cmap.xy1;c.y<-16||c.y>cmap.h+16||c.x<-16||c.x>cmap.w+16?cmap.drawing=0:(cmap.xy0=cmap.xy1,cmap.xy1=null)}}var e=JSON.stringify(cmap.save);localStorage.setItem("colormap",e)}function colormap_escape_key_cb(){return!(cmap.draw!=cmap.draw_e.lines||!cmap.drawing)&&(colormap_transfer_mouseup_cb(null,!0),!0)}function colormap_bresenham(a,r,c){for(var e=a.x,p=a.y,o=r.x,m=r.y,_=Math.abs(o-e),i=Math.abs(m-p),l=e<o?1:-1,n=p<m?1:-1,t=_-i;e!=o||p!=m;){var w=2*t;w>-1*i&&(t-=i,e+=l),w<_&&(t+=_,p+=n),c(e,p)}}function colormap_update(){wf_send("SET aper="+wf.aper+" algo="+wf.aper_algo+" param="+wf.aper_param.toFixed(2))}function colormap_exp_cb(a,r){r=+r,w3_num_cb(a,r),w3_set_label("Exp "+r.toFixed(2),a),cmap.ef=r,colormap_plot()}function colormap_gain_cb(a,r){r=+r,w3_num_cb(a,r),w3_set_label("Gain "+r.toFixed(2),a),colormap_plot()}


